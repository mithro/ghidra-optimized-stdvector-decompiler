name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:

jobs:
  build:
    name: Build Extension
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: ['21']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java-version }}
          cache: 'gradle'

      - name: Setup Ghidra
        uses: ./.github/actions/setup-ghidra
        with:
          ghidra-version: '11.4.2'

      - name: Build extension
        run: |
          cd extension
          chmod +x build.sh
          ./build.sh

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-jar-java${{ matrix.java-version }}
          path: extension/build/libs/*.jar
          retention-days: 7

  test:
    name: Test with Ghidra ${{ matrix.ghidra-version }}
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        ghidra-version: ['11.4.1', '11.4.2']
        java-version: ['21']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java-version }}

      - name: Setup Ghidra
        uses: ./.github/actions/setup-ghidra
        with:
          ghidra-version: ${{ matrix.ghidra-version }}

      - name: Download extension JAR
        uses: actions/download-artifact@v4
        with:
          name: extension-jar-java${{ matrix.java-version }}
          path: extension/build/libs/

      - name: Debug - List downloaded files
        run: |
          echo "Contents of extension/build/libs/:"
          ls -lR extension/build/libs/ || echo "Directory not found"
          echo "Looking for JAR from setup.sh perspective:"
          SCRIPT_DIR="$(pwd)"
          echo "SCRIPT_DIR=$SCRIPT_DIR"
          echo "Looking for: $SCRIPT_DIR/extension/build/libs/OptimizedVectorDecompiler.jar"
          ls -l "$SCRIPT_DIR/extension/build/libs/OptimizedVectorDecompiler.jar" || echo "JAR not found at expected path"

      - name: Install extension using setup.sh
        run: |
          # Run setup.sh with --skip-build since JAR already exists
          ./setup.sh --skip-build
        env:
          GHIDRA_INSTALL_DIR: ${{ env.GHIDRA_INSTALL_DIR }}

      - name: Setup Python and uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Run integration tests
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv run python test_all_compilers.py
        env:
          GHIDRA_INSTALL_DIR: ${{ env.GHIDRA_INSTALL_DIR }}

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-ghidra${{ matrix.ghidra-version }}
          path: |
            **/*.log
            /tmp/*.log
          retention-days: 7
