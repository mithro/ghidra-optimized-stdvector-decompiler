name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:

jobs:
  build:
    name: Build Extension
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: ['21']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java-version }}
          cache: 'gradle'

      - name: Setup Ghidra
        uses: ./.github/actions/setup-ghidra
        with:
          ghidra-version: '11.4.2'

      - name: Build extension
        run: |
          cd extension
          chmod +x build.sh
          ./build.sh

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-jar-java${{ matrix.java-version }}
          path: extension/build/libs/*.jar
          retention-days: 7

  test:
    name: Test with Ghidra ${{ matrix.ghidra-version }}
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        ghidra-version: ['11.4.1', '11.4.2']
        java-version: ['21']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java-version }}

      - name: Setup Ghidra
        uses: ./.github/actions/setup-ghidra
        with:
          ghidra-version: ${{ matrix.ghidra-version }}

      - name: Download extension JAR
        uses: actions/download-artifact@v4
        with:
          name: extension-jar-java${{ matrix.java-version }}
          path: extension/build/libs/

      - name: Debug - Environment and paths
        run: |
          echo "=== Environment Variables ==="
          echo "GHIDRA_INSTALL_DIR=$GHIDRA_INSTALL_DIR"
          echo "HOME=$HOME"
          echo ""
          echo "=== Ghidra Installation ==="
          ls -la "$GHIDRA_INSTALL_DIR/" || echo "GHIDRA_INSTALL_DIR not found"
          echo ""
          echo "=== Downloaded JAR ==="
          ls -lR extension/build/libs/ || echo "JAR directory not found"
          echo ""
          echo "=== Extension directories (before install) ==="
          echo "Extensions dir:"
          ls -la "$GHIDRA_INSTALL_DIR/Extensions/Ghidra/" 2>/dev/null || echo "Extensions/Ghidra/ not found"
          echo "Decompiler lib:"
          ls -la "$GHIDRA_INSTALL_DIR/Ghidra/Features/Decompiler/lib/" 2>/dev/null || echo "Decompiler/lib not found"

      - name: Install extension using setup.sh
        run: |
          # Run setup.sh with --skip-build since JAR already exists
          echo "Running setup.sh with GHIDRA_INSTALL_DIR=$GHIDRA_INSTALL_DIR"
          ./setup.sh --skip-build
        env:
          GHIDRA_INSTALL_DIR: ${{ env.GHIDRA_INSTALL_DIR }}

      - name: Verify extension installation
        run: |
          echo "=== Verifying extension installation ==="
          echo "Checking Extensions directory:"
          ls -la "$GHIDRA_INSTALL_DIR/Extensions/Ghidra/" || echo "Not found"
          echo ""
          echo "Checking Decompiler lib:"
          ls -la "$GHIDRA_INSTALL_DIR/Ghidra/Features/Decompiler/lib/" || echo "Not found"
          echo ""
          echo "Looking for OptimizedVectorDecompiler.jar:"
          find "$GHIDRA_INSTALL_DIR" -name "OptimizedVectorDecompiler.jar" -ls || echo "JAR not found anywhere"

      - name: Setup Python and uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Run integration tests
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv run python test.py
        env:
          GHIDRA_INSTALL_DIR: ${{ env.GHIDRA_INSTALL_DIR }}

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-ghidra${{ matrix.ghidra-version }}
          path: |
            **/*.log
            /tmp/*.log
          retention-days: 7
