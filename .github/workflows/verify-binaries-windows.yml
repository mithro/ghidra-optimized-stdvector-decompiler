name: Verify Binaries (Windows)

on:
  pull_request:
    paths:
      - 'demo/*.cpp'
  push:
    paths:
      - 'demo/*.cpp'
  workflow_dispatch:

jobs:
  verify-windows:
    name: Rebuild and verify binaries (Native MSVC)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Backup committed binaries before rebuild
        shell: bash
        run: |
          cd demo
          for binary in vector_extra_O2.exe vector_extra_Od.exe; do
            if [ -f "$binary" ]; then
              cp "$binary" "$binary.committed"
              echo "Backed up $binary to $binary.committed"
              ls -lh "$binary.committed"
            else
              echo "ERROR: Committed binary not found: $binary"
              exit 1
            fi
          done

      - name: Build binaries with MSVC
        shell: cmd
        run: |
          cd demo

          REM Build optimized version
          cl /EHsc /O2 /Zi /std:c++17 /Fe:vector_extra_O2.exe vector_extra.cpp /link /DEBUG /PDB:vector_extra_O2.pdb
          if not exist vector_extra_O2.exe (
            echo ERROR: Failed to build vector_extra_O2.exe
            exit /b 1
          )

          REM Build debug version
          cl /EHsc /Od /Zi /std:c++17 /Fe:vector_extra_Od.exe vector_extra.cpp /link /DEBUG /PDB:vector_extra_Od.pdb
          if not exist vector_extra_Od.exe (
            echo ERROR: Failed to build vector_extra_Od.exe
            exit /b 1
          )

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        shell: bash
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Compare rebuilt binaries to committed versions
        shell: bash
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          cd demo

          EXIT_CODE=0

          for binary in vector_extra_O2.exe vector_extra_Od.exe; do
            echo ""
            echo "=========================================="
            echo "Comparing $binary"
            echo "=========================================="

            # Verify the binary was rebuilt
            if [ ! -f "$binary" ]; then
              echo "ERROR: Failed to rebuild $binary"
              EXIT_CODE=1
              continue
            fi

            # Compare committed vs rebuilt
            if uv run python scripts/compare_binaries.py \
                "$binary.committed" \
                "$binary"; then
              echo "SUCCESS: $binary matches committed version"
            else
              COMPARE_EXIT=$?
              if [ $COMPARE_EXIT -eq 1 ]; then
                echo ""
                echo "ERROR: $binary differs from committed version!"
                EXIT_CODE=1
              else
                echo "ERROR: Comparison failed with exit code $COMPARE_EXIT"
                EXIT_CODE=2
              fi
            fi
          done

          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "============================================================"
            echo "ERROR: Binary verification failed!"
            echo "============================================================"
            echo ""
            echo "To update binaries on Windows:"
            echo "  1. Setup MSVC build environment"
            echo "  2. cd demo"
            echo "  3. cl /EHsc /O2 /Zi /std:c++17 /Fe:vector_extra_O2.exe vector_extra.cpp /link /DEBUG"
            echo "  4. cl /EHsc /Od /Zi /std:c++17 /Fe:vector_extra_Od.exe vector_extra.cpp /link /DEBUG"
            echo "  5. git add vector_extra_O2.exe vector_extra_Od.exe *.pdb"
            echo "  6. git commit -m 'build: Update demo binaries'"
            echo "============================================================"
          fi

          exit $EXIT_CODE

      - name: Upload rebuilt binaries for inspection
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rebuilt-binaries-windows
          path: |
            demo/vector_extra_O2.exe
            demo/vector_extra_Od.exe
            demo/*.pdb
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-windows
          path: demo/*.log
          retention-days: 7
