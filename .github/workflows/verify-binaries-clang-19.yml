name: Verify Binaries (clang-19)

on:
  pull_request:
    paths:
      - 'demo/**'
      - '.github/workflows/verify-binaries-clang-19.yml'
  push:
    paths:
      - 'demo/**'
      - '.github/workflows/verify-binaries-clang-19.yml'
  workflow_dispatch:

jobs:
  verify-clang-19:
    name: Verify committed binaries match source (Wine + clang-19)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code with committed binaries
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install build tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3 msitools ca-certificates wget git curl

      - name: Backup committed binaries before rebuild
        run: |
          cd demo
          BINARIES_EXIST=true
          for binary in out/clang-19/vector_extra_O2.exe out/clang-19/vector_extra_Od.exe; do
            if [ -f "$binary" ]; then
              cp "$binary" "$binary.committed"
              echo "Backed up $binary ($(stat -c%s $binary) bytes)"
            else
              echo "WARNING: Committed binary not found: $binary (will build fresh)"
              BINARIES_EXIST=false
            fi
          done

          if [ "$BINARIES_EXIST" = "false" ]; then
            echo "BINARIES_EXIST=false" >> $GITHUB_ENV
            echo "No existing binaries - will build and upload for initial commit"
          else
            echo "BINARIES_EXIST=true" >> $GITHUB_ENV
          fi

      - name: Rebuild binaries from current source code
        run: |
          cd demo
          chmod +x setup_build_env.sh
          # Auto-confirm setup (non-interactive for CI)
          echo "y" | ./setup_build_env.sh
          make COMPILER=clang-19 extra
        timeout-minutes: 45

      - name: Setup Python and uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Verify committed binaries match rebuilt binaries
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          cd demo

          # Skip comparison if no binaries existed before (first build)
          if [ "$BINARIES_EXIST" = "false" ]; then
            echo "============================================================"
            echo "First build - no committed binaries to verify"
            echo "============================================================"
            echo ""
            echo "Built binaries:"
            for binary in out/clang-19/vector_extra_O2.exe out/clang-19/vector_extra_Od.exe; do
              if [ -f "$binary" ]; then
                ls -lh "$binary"
              else
                echo "ERROR: Failed to build $binary"
                exit 1
              fi
            done
            echo ""
            echo "Download the 'rebuilt-binaries-clang-19' artifact and commit:"
            echo "  1. Download artifact from this workflow run"
            echo "  2. cd demo/out"
            echo "  3. Copy downloaded files to clang-19/"
            echo "  4. git add clang-19/*.exe clang-19/*.pdb"
            echo "  5. git commit -m 'build: Add clang-19 demo binaries'"
            echo "  6. git push"
            echo "  7. cd ../.."
            echo "  8. git add demo/out"
            echo "  9. git commit -m 'chore: Update submodule with clang-19 binaries'"
            echo " 10. git push"
            exit 0
          fi

          EXIT_CODE=0

          for binary in out/clang-19/vector_extra_O2.exe out/clang-19/vector_extra_Od.exe; do
            echo ""
            echo "=========================================="
            echo "Comparing $binary"
            echo "=========================================="

            # Verify the binary was rebuilt
            if [ ! -f "$binary" ]; then
              echo "ERROR: Failed to rebuild $binary"
              EXIT_CODE=1
              continue
            fi

            # Compare committed vs rebuilt to verify reproducibility
            if uv run python scripts/compare_binaries.py \
                "$binary.committed" \
                "$binary"; then
              echo "✓ PASS: Committed binary matches current source/config"
            else
              COMPARE_EXIT=$?
              if [ $COMPARE_EXIT -eq 1 ]; then
                echo ""
                echo "✗ ERROR: $binary is NOT reproducible!"
                echo "  Rebuilt binary differs from committed version"
                EXIT_CODE=1
              else
                echo "ERROR: Comparison failed with exit code $COMPARE_EXIT"
                EXIT_CODE=2
              fi
            fi
          done

          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "============================================================"
            echo "ERROR: Committed binaries are out of sync with source!"
            echo "============================================================"
            echo ""
            echo "To update binaries:"
            echo "  1. cd demo"
            echo "  2. ./setup_build_env.sh"
            echo "  3. make COMPILER=clang-19 extra"
            echo "  4. git add out/clang-19/vector_extra_O2.exe out/clang-19/vector_extra_Od.exe out/clang-19/*.pdb"
            echo "  5. git commit -m 'build: Update clang-19 demo binaries'"
            echo "============================================================"
          fi

          exit $EXIT_CODE

      - name: Upload rebuilt binaries for inspection
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rebuilt-binaries-clang-19
          path: |
            demo/out/clang-19/vector_extra_O2.exe
            demo/out/clang-19/vector_extra_Od.exe
            demo/out/clang-19/*.pdb
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-clang-19
          path: demo/*.log
          retention-days: 7
