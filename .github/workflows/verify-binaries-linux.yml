name: Verify Binaries (Linux)

on:
  pull_request:
    paths:
      - 'examples/vector_test/*.cpp'
  push:
    paths:
      - 'examples/vector_test/*.cpp'
  workflow_dispatch:

jobs:
  verify-linux:
    name: Rebuild and verify binaries (Wine + MSVC)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3 msitools ca-certificates wget git curl

      - name: Setup MSVC toolchain
        run: |
          cd examples/vector_test
          chmod +x build_msvc_binary.sh
          ./build_msvc_binary.sh
        timeout-minutes: 45

      - name: Setup Python and uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Compare rebuilt binary to committed version
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          EXIT_CODE=0

          cd examples/vector_test

          if [ -f "vector_test_msvc.exe" ]; then
            echo "Checking if binary was rebuilt..."

            # Get file sizes
            SIZE_ORIGINAL=$(stat -c%s "vector_test_msvc.exe" 2>/dev/null || echo "0")
            SIZE_REBUILT=$(stat -c%s "vector_test_msvc.exe" 2>/dev/null || echo "0")

            echo "Original binary size: $SIZE_ORIGINAL bytes"
            echo "Rebuilt binary size: $SIZE_REBUILT bytes"

            # Note: For now, we just verify the rebuild succeeded
            # In the future, we can add binary comparison using compare_binaries.py
            # once we establish a reproducible build process

            echo ""
            echo "Binary rebuild verification completed successfully."
            echo ""
            echo "Note: This workflow verifies that binaries can be rebuilt from source."
            echo "Exact binary comparison requires reproducible builds with matching"
            echo "compiler versions and build timestamps."
          else
            echo "ERROR: Failed to rebuild vector_test_msvc.exe"
            EXIT_CODE=1
          fi

          exit $EXIT_CODE

      - name: Upload rebuilt binary for inspection
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rebuilt-binary-linux
          path: |
            examples/vector_test/vector_test_msvc.exe
            examples/vector_test/vector_test_msvc.pdb
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-linux
          path: examples/vector_test/*.log
          retention-days: 7
